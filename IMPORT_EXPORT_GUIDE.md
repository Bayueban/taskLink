# 数据导入导出功能使用指南

## 📦 新增功能

### 1. StorageManager API 持久化存储

应用现在使用 StorageManager API 来请求浏览器的持久化存储权限，确保数据不会被浏览器自动清理。

**特性**:
- ✅ 自动请求持久化存储权限
- ✅ 数据不会被浏览器自动清除
- ✅ 实时显示存储使用情况
- ✅ 支持更大的存储空间

**技术实现**:
```typescript
// 自动请求持久化
await navigator.storage.persist();

// 获取存储使用情况
const estimate = await navigator.storage.estimate();
```

---

## 💾 数据导入导出功能

### 访问设置面板

1. 打开应用
2. 在左侧面板顶部找到 ⚙️ **设置** 按钮
3. 点击打开设置面板

### 功能说明

#### 📊 存储信息
- **显示当前存储使用量**（MB）
- **显示存储配额**
- **显示使用百分比**（进度条）

#### 📤 导出功能

##### 1. 导出所有数据
- **文件名**: `todolist-backup-YYYY-MM-DD.json`
- **包含内容**:
  - 所有工作区
  - 所有任务
  - 所有节点
  - 所有连线
  - 视图状态
  - 应用设置

##### 2. 导出当前工作区
- **文件名**: `workspace-[工作区名称]-YYYY-MM-DD.json`
- **包含内容**:
  - 当前工作区信息
  - 该工作区的所有任务
  - 该工作区的所有节点和连线
  - 该工作区的视图状态

#### 📥 导入功能

##### 1. 导入数据（覆盖模式）
- ⚠️ **会删除所有现有数据**
- 导入备份文件中的所有数据
- 适用于：完全恢复备份

**操作流程**:
1. 点击 "导入数据（覆盖）"
2. 选择 `.json` 备份文件
3. 确认覆盖提示
4. 自动刷新页面加载新数据

##### 2. 导入数据（合并模式）
- ✅ **保留现有数据**
- 只添加不存在的数据（根据 ID 判断）
- ID 冲突的数据会被跳过
- 适用于：合并多个备份、导入单个工作区

**操作流程**:
1. 点击 "导入数据（合并）"
2. 选择 `.json` 备份文件
3. 确认合并提示
4. 自动刷新页面加载数据

---

## 📋 导出数据格式

```json
{
  "version": "1.0.0",
  "exportDate": "2026-01-10T12:00:00.000Z",
  "data": {
    "workspaces": [...],
    "todos": [...],
    "nodes": [...],
    "edges": [...],
    "viewStates": [...],
    "settings": [...]
  }
}
```

---

## 🎯 使用场景

### 场景 1: 定期备份
**建议**: 每周或每月导出所有数据作为备份

```
操作: 设置 → 导出所有数据
结果: 得到完整的备份文件
```

### 场景 2: 换设备/浏览器
**目标**: 在新设备上恢复所有数据

```
旧设备: 设置 → 导出所有数据
新设备: 设置 → 导入数据（覆盖）
```

### 场景 3: 分享工作区
**目标**: 将某个工作区分享给他人

```
操作: 设置 → 导出当前工作区
分享: 发送 JSON 文件给对方
对方: 设置 → 导入数据（合并）
```

### 场景 4: 合并多个备份
**目标**: 整合多个备份文件的数据

```
操作: 依次导入多个备份文件
选择: 导入数据（合并）模式
结果: 所有数据汇总到一起
```

### 场景 5: 数据恢复
**情况**: 不小心删除了重要数据

```
操作: 使用最近的备份文件
选择: 导入数据（覆盖）模式
结果: 恢复到备份时的状态
```

---

## ⚠️ 注意事项

### 导出相关
1. **定期备份**: 建议定期导出数据作为备份
2. **文件保存**: 妥善保存导出的 JSON 文件
3. **隐私安全**: 备份文件包含所有数据，注意保密

### 导入相关
1. **覆盖模式**: 会删除所有现有数据，请谨慎使用
2. **合并模式**: 适合导入单个工作区或整合数据
3. **数据校验**: 导入前会验证文件格式
4. **自动刷新**: 导入成功后会自动刷新页面

### 文件格式
1. **必须是 JSON 格式**
2. **必须包含 version 和 data 字段**
3. **由本应用导出的文件最安全**

---

## 🔧 技术细节

### StorageManager API

#### 持久化存储
```typescript
// 检查是否已持久化
const isPersisted = await navigator.storage.persisted();

// 请求持久化
const granted = await navigator.storage.persist();
```

#### 存储估算
```typescript
const estimate = await navigator.storage.estimate();
console.log('使用量:', estimate.usage);
console.log('配额:', estimate.quota);
```

### 数据导入导出

#### 导出实现
```typescript
// 1. 从 Dexie 读取所有数据
const data = await Promise.all([
  db.workspaces.toArray(),
  db.todos.toArray(),
  // ...
]);

// 2. 构建导出对象
const exportData = { version, exportDate, data };

// 3. 生成 JSON 并下载
const blob = new Blob([JSON.stringify(exportData, null, 2)]);
const url = URL.createObjectURL(blob);
// 触发下载
```

#### 导入实现（覆盖）
```typescript
// 1. 读取文件
const text = await file.text();
const data = JSON.parse(text);

// 2. 使用事务清空并导入
await db.transaction('rw', [...tables], async () => {
  await Promise.all([...tables.map(t => t.clear())]);
  await Promise.all([...tables.map(t => t.bulkAdd(data))]);
});
```

#### 导入实现（合并）
```typescript
// 逐条检查并添加不存在的数据
for (const item of items) {
  const exists = await db.table.get(item.id);
  if (!exists) {
    await db.table.add(item);
  }
}
```

---

## 🐛 故障排查

### 问题 1: 导出失败

**可能原因**:
- 数据库访问错误
- 浏览器权限问题

**解决方案**:
1. 刷新页面重试
2. 检查浏览器控制台错误
3. 确保有足够的磁盘空间

### 问题 2: 导入失败

**可能原因**:
- 文件格式不正确
- 文件损坏
- 数据格式版本不兼容

**解决方案**:
1. 确认文件是 JSON 格式
2. 使用本应用导出的文件
3. 检查文件内容是否完整

### 问题 3: 数据覆盖错误

**情况**: 不小心选择了覆盖模式

**恢复方法**:
1. 如果有旧备份，重新导入
2. 浏览器可能有缓存数据
3. 检查 IndexedDB 是否还有数据

---

## 📈 最佳实践

### 备份策略
1. **日常备份**: 重要工作日结束时导出
2. **周备份**: 每周导出一次完整数据
3. **月备份**: 每月归档一份长期保存
4. **多地备份**: 保存在云盘、U盘等多个位置

### 数据管理
1. **清理旧备份**: 定期删除过期的备份文件
2. **版本控制**: 在文件名中包含日期
3. **工作区分离**: 大项目使用独立工作区，便于导出分享

### 安全建议
1. **加密存储**: 重要备份可以加密保存
2. **访问控制**: 限制备份文件的访问权限
3. **定期检查**: 定期验证备份文件可用性

---

## 🎉 功能优势

### 相比 localStorage
- ✅ **不会被清理**: 持久化存储
- ✅ **更大容量**: 支持 GB 级数据
- ✅ **更快访问**: 异步不阻塞
- ✅ **易于备份**: 一键导出所有数据

### 数据安全
- ✅ **本地存储**: 数据不上传服务器
- ✅ **完全控制**: 用户完全掌控数据
- ✅ **随时备份**: 一键导出完整备份
- ✅ **灵活恢复**: 覆盖或合并模式

### 跨平台
- ✅ **跨设备**: 导出导入实现数据同步
- ✅ **跨浏览器**: 在不同浏览器间迁移
- ✅ **易分享**: 导出工作区分享给他人

---

## 📞 常见问题

**Q: 导出的文件可以手动编辑吗？**
A: 可以，但需要保持 JSON 格式正确。建议备份原文件后再编辑。

**Q: 导入会影响性能吗？**
A: 大数据量导入会有短暂的等待，但会自动刷新页面加载新数据。

**Q: 可以导入其他人的备份吗？**
A: 可以，使用"合并模式"导入，不会覆盖你的数据。

**Q: 持久化存储一定会成功吗？**
A: 不一定。浏览器会根据网站的使用情况决定是否授予权限。

**Q: 数据会同步到云端吗？**
A: 不会。所有数据都存储在本地浏览器中。

---

**版本**: 2.0.0  
**更新日期**: 2026-01-10
